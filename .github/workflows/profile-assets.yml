name: Update all profile assets

on:
  push:
    paths-ignore:
      - 'assets/**'
  schedule:
    - cron: "17 2 * * *"     # daily
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: profile-assets
  cancel-in-progress: false

jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      # Cards (feel free to switch back to jacoblin.cool if you prefer)
      HEATMAP_URL: "https://leetcard.jacoblin.cool/Kelony11?ext=heatmap&theme=dark&cache=0"
      HEATMAP_OUT: "assets/leetcode-heatmap.svg"
      QUOTE_URL:   "https://quotes-github-readme.vercel.app/api?type=horizontal&theme=radical"
      QUOTE_OUT:   "assets/random_dev_quote.svg"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare folder
        run: mkdir -p assets

      - name: Fetch LeetCode heatmap (retry + validate)
        run: |
          tmp="$(mktemp)"
          for i in {1..5}; do
            curl -fsSL -H "Accept: image/svg+xml" -A "gh-actions-profile-assets" \
              "$HEATMAP_URL" -o "$tmp" && break || sleep 10
          done
          if [ -s "$tmp" ] && grep -qi "<svg" "$tmp"; then mv "$tmp" "$HEATMAP_OUT"; else echo "::warning::heatmap not svg"; rm -f "$tmp"; fi

      - name: Fetch Dev Quote (retry + validate)
        run: |
          tmp="$(mktemp)"
          for i in {1..5}; do
            curl -fsSL -H "Accept: image/svg+xml" -A "gh-actions-profile-assets" \
              "$QUOTE_URL" -o "$tmp" && break || sleep 10
          done
          if [ -s "$tmp" ] && grep -qi "<svg" "$tmp"; then mv "$tmp" "$QUOTE_OUT"; else echo "::warning::quote not svg"; rm -f "$tmp"; fi

      - name: Fetch badge SVGs (JavaScript, TypeScript, Python, Swift, SQL, C++)
        shell: bash
        run: |
          declare -A badges=(
            ["JavaScript"]="https://www.vectorlogo.zone/logos/javascript/javascript-icon.svg"
            ["TypeScript"]="https://www.vectorlogo.zone/logos/typescriptlang/typescriptlang-icon.svg"
            ["Python"]="https://www.vectorlogo.zone/logos/python/python-icon.svg"
            ["Swift"]="https://www.vectorlogo.zone/logos/swift/swift-icon.svg"
            ["PostgreSQL"]="https://www.vectorlogo.zone/logos/postgresql/postgresql-icon.svg"
            ["C++.svg"]="https://www.vectorlogo.zone/logos/isocpp/isocpp-icon.svg"
            ["React.svg"]="https://www.vectorlogo.zone/logos/reactjs/reactjs-icon.svg"
            ["Node.js.svg"]="https://www.vectorlogo.zone/logos/nodejs/nodejs-icon.svg"
            ["Django.svg"]="https://static.djangoproject.com/img/logos/django-logo-negative.svg"
            ["SQL"]="https://www.vectorlogo.zone/logos/mysql/mysql-icon.svg"
            ["Git"]="https://www.vectorlogo.zone/logos/git-scm/git-scm-icon.svg"
            ["Postman"]="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/postman/postman-original.svg"
            ["Linux"]="https://www.vectorlogo.zone/logos/linux/linux-icon.svg"
            ["Jasmine"]="https://www.vectorlogo.zone/logos/jasmine/jasmine-icon.svg"
            ["Pytest"]="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/pytest/pytest-original.svg"
            ["Firebase"]="https://www.vectorlogo.zone/logos/firebase/firebase-icon.svg"
            ["Rest-Json"]="https://cdn.simpleicons.org/swagger/85EA2D.svg"
            ["AWS"]="https://www.vectorlogo.zone/logos/amazon_aws/amazon_aws-icon.svg"
            ["Docker"]="https://www.vectorlogo.zone/logos/docker/docker-icon.svg"
            ["Github-actions"]="https://www.vectorlogo.zone/logos/github/github-icon.svg"
            ["C"]="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/c/c-original.svg"
            ["MongoDB"]="https://www.vectorlogo.zone/logos/mongodb/mongodb-icon.svg"
            ["Yahoo_finance_api"]="https://www.vectorlogo.zone/logos/yahoo/yahoo-icon.svg"
            
          )
          # Note: map key "C++.svg" ensures the output filename contains the plus signs.
          for name in "${!badges[@]}"; do
            url="${badges[$name]}"
            out="assets/${name}"
            [[ "$name" != *".svg" ]] && out="assets/${name}.svg"
            t="$(mktemp)"
            for i in {1..5}; do
              curl -fsSL -H "Accept: image/svg+xml" -A "gh-actions-profile-assets" \
                "$url" -o "$t" && break || sleep 5
            done
            if [ -s "$t" ] && grep -qi "<svg" "$t"; then
              mv "$t" "$out"
            else
              echo "::warning::badge $name not svg"
              rm -f "$t"
            fi
          done

      - name: Commit if any asset changed
        run: |
          if [[ -n "$(git status --porcelain assets/)" ]]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add assets/*.svg
            git commit -m "chore: update profile assets (heatmap/quote/badges)"
            git push
          else
            echo "No changes in assets."
          fi
